#!/usr/bin/env lua
local PKGLET_LIB = "/usr/lib/pkglet"
package.path = PKGLET_LIB .. "/?.lua;" .. package.path
local cli = require("src.cli")
local loader = require("src.loader")
local installer = require("src.installer")
local resolver = require("src.resolver")
local config = require("src.config")
local function main()
    config.init()
    local args = cli.parse(arg)
    if args.command == "i" or args.command == "install" then
        local manifest = loader.load_manifest(args.package)
        local deps = resolver.resolve_dependencies(manifest)
        for _, dep in ipairs(deps) do
            local dep_manifest = loader.load_manifest(dep)
            installer.install(dep_manifest, args)
        end
        installer.install(manifest, args)

    elseif args.command == "u" or args.command == "uninstall" then
        local manifest = loader.load_manifest(args.package)
        installer.uninstall(manifest)

    elseif args.command == "s" or args.command == "search" then
        local search = require("src.search")
        search.query(args.package)

    elseif args.command == "S" or args.command == "sync" then
        local sync = require("src.sync")
        sync.update_repos()

    elseif args.command == "I" or args.command == "info" then
        local manifest = loader.load_manifest(args.package)
        loader.print_info(manifest)

    elseif args.command == "c" or args.command == "clean" then
        os.execute("rm -rf " .. config.CACHE_PATH)

    else
        cli.print_help()
        os.exit(1)
    end
end

local status, err = pcall(main)
if not status then
    io.stderr:write("\27[1;32mpkglet\27[0m: \27[1;31merror\27[0m: " .. tostring(err) .. "\n")
    os.exit(1)
end
